import { PrismaClient, Prisma, UserRole, BankInfoType, CampaignStatus, DonationStatus, WithdrawalStatus } from '@prisma/client';
import * as bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

// ==================== SEED PRINCIPAL ====================
async function seedMain() {
  console.log('üå± Seeding main data...');

  // Users
  const passwordAdmin = await bcrypt.hash('Admin@123', 10);
  const passwordDonor = await bcrypt.hash('Donor@123', 10);
  const passwordRequester = await bcrypt.hash('Requester@123', 10);

  const admin = await prisma.user.upsert({
    where: { email: 'admin@example.com' },
    update: {},
    create: {
      email: 'admin@example.com',
      firstName: 'Admin',
      lastName: 'User',
      password: passwordAdmin,
      role: UserRole.admin,
      isVerified: true,
      phone: '+261340000000',
    },
  });

  const donor = await prisma.user.upsert({
    where: { email: 'donor@example.com' },
    update: {},
    create: {
      email: 'donor@example.com',
      firstName: 'Dona',
      lastName: 'Teur',
      password: passwordDonor,
      role: UserRole.donateur,
      isVerified: true,
      phone: '+261331111111',
    },
  });

  const requester = await prisma.user.upsert({
    where: { email: 'requester@example.com' },
    update: {},
    create: {
      email: 'requester@example.com',
      firstName: 'Reques',
      lastName: 'Teur',
      password: passwordRequester,
      role: UserRole.demandeur,
      isVerified: true,
      phone: '+261321222222',
    },
  });

  // Categories
  const categoryNames = ['Sant√©', '√âducation', 'Environnement', 'Entrepreneuriat'];
  const categories = await Promise.all(
    categoryNames.map((name) =>
      prisma.category.upsert({
        where: { name },
        update: {},
        create: { name },
      })
    )
  );

  // Bank Infos for requester
  const requesterMomo = await prisma.bankInfo.upsert({
    where: { id: 'seed-momo' },
    update: {},
    create: {
      id: 'seed-momo',
      userId: requester.id,
      type: BankInfoType.mobile_money,
      accountNumber: '0341234567',
      accountName: 'Requester Momo',
      provider: 'Orange Money',
      isDefault: true,
    },
  });

  const requesterBank = await prisma.bankInfo.upsert({
    where: { id: 'seed-bank' },
    update: {},
    create: {
      id: 'seed-bank',
      userId: requester.id,
      type: BankInfoType.bank_account,
      accountNumber: '000123456789',
      accountName: 'Requester Bank',
      provider: 'BOA',
      isDefault: false,
    },
  });

  // Campaigns
  const [sante, education] = categories;
  const campaignA = await prisma.campaign.upsert({
    where: { id: 'seed-camp-a' },
    update: {},
    create: {
      id: 'seed-camp-a',
      title: 'Op√©ration chirurgicale urgente',
      description: 'Aider √† financer une op√©ration vitale.',
      targetAmount: new Prisma.Decimal('5000.00'),
      currentAmount: new Prisma.Decimal('0'),
      categoryId: sante.id,
      images: ['https://picsum.photos/seed/campA/800/400'],
      video: null,
      deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      status: CampaignStatus.active,
      createdBy: requester.id,
      rating: new Prisma.Decimal('4.50'),
      totalDonors: 0,
      isVerified: true,
    },
  });

  const campaignB = await prisma.campaign.upsert({
    where: { id: 'seed-camp-b' },
    update: {},
    create: {
      id: 'seed-camp-b',
      title: "Fournitures scolaires pour l\'ann√©e",
      description: "Aider des √©l√®ves √† obtenir des fournitures scolaires.",
      targetAmount: new Prisma.Decimal('2000.00'),
      currentAmount: new Prisma.Decimal('0'),
      categoryId: education.id,
      images: ['https://picsum.photos/seed/campB/800/400'],
      deadline: new Date(Date.now() + 20 * 24 * 60 * 60 * 1000),
      status: CampaignStatus.active,
      createdBy: requester.id,
      rating: new Prisma.Decimal('4.20'),
      totalDonors: 0,
      isVerified: true,
    },
  });

  // Donations
  const donation1 = await prisma.donation.create({
    data: {
      campaignId: campaignA.id,
      donorId: donor.id,
      amount: new Prisma.Decimal('150.00'),
      message: 'Bon r√©tablissement !',
      isAnonymous: false,
      paymentMethod: 'card',
      status: DonationStatus.completed,
    },
  });

  const donation2 = await prisma.donation.create({
    data: {
      campaignId: campaignA.id,
      donorId: null,
      amount: new Prisma.Decimal('75.50'),
      isAnonymous: true,
      paymentMethod: 'mobile_money',
      status: DonationStatus.completed,
    },
  });

  const donation3 = await prisma.donation.create({
    data: {
      campaignId: campaignB.id,
      donorId: donor.id,
      amount: new Prisma.Decimal('50.00'),
      message: 'Bon courage !',
      isAnonymous: false,
      paymentMethod: 'card',
      status: DonationStatus.completed,
    },
  });

  // Update campaign amounts based on donations
  await prisma.campaign.update({
    where: { id: campaignA.id },
    data: {
      currentAmount: new Prisma.Decimal('225.50'),
      totalDonors: 2,
    },
  });
  await prisma.campaign.update({
    where: { id: campaignB.id },
    data: {
      currentAmount: new Prisma.Decimal('50.00'),
      totalDonors: 1,
    },
  });

  // Favorites
  await prisma.favorite.upsert({
    where: { userId_campaignId: { userId: donor.id, campaignId: campaignA.id } },
    update: {},
    create: { userId: donor.id, campaignId: campaignA.id },
  });

  // Campaign Updates
  await prisma.campaignUpdate.createMany({
    data: [
      { campaignId: campaignA.id, title: 'Premi√®re mise √† jour', content: 'Merci pour vos premiers dons !' },
      { campaignId: campaignA.id, title: 'Progression', content: 'Nous avons atteint 10% de l\'objectif.' },
      { campaignId: campaignB.id, title: 'D√©marrage', content: 'La campagne d√©marre bien, merci !' },
    ],
    skipDuplicates: true,
  });

  // Thank You Messages
  await prisma.thankYouMessage.createMany({
    data: [
      { campaignId: campaignA.id, donationId: donation1.id, message: 'Merci pour votre g√©n√©rosit√© !' },
      { campaignId: campaignA.id, donationId: donation2.id, message: 'Merci pour votre don anonyme.' },
      { campaignId: campaignB.id, donationId: donation3.id, message: 'Votre aide compte beaucoup.' },
    ],
    skipDuplicates: true,
  });

  // Withdrawal Requests
  await prisma.withdrawalRequest.createMany({
    data: [
      {
        campaignId: campaignA.id,
        requestedBy: requester.id,
        amount: new Prisma.Decimal('100.00'),
        bankInfoId: requesterMomo.id,
        justification: 'Payer l\'h√¥pital',
        documents: ['invoice-001.pdf'],
        status: WithdrawalStatus.pending,
      },
      {
        campaignId: campaignB.id,
        requestedBy: requester.id,
        amount: new Prisma.Decimal('40.00'),
        bankInfoId: requesterBank.id,
        justification: 'Achat de fournitures',
        documents: ['quote-abc.pdf'],
        status: WithdrawalStatus.approved,
        processedBy: admin.id,
        processedAt: new Date(),
        notes: 'Approuv√© par admin',
      },
    ],
    skipDuplicates: true,
  });

  console.log('‚úÖ Main seed completed');
  return { admin, donor, requester };
}

// ==================== SEED ADMIN BANK INFO ====================
async function seedAdminBankInfo(admin: any) {
  try {
    console.log('üå± Seeding admin bank info...');

    console.log(`‚úÖ Utilisateur admin trouv√©: ${admin.firstName} ${admin.lastName}`);

    // Mettre √† jour le t√©l√©phone de l'admin
    const updatedAdmin = await prisma.user.update({
      where: { id: admin.id },
      data: {
        phone: '0341234567'
      }
    });

    console.log(`‚úÖ T√©l√©phone mis √† jour: ${updatedAdmin.phone}`);

    // Supprimer les anciennes informations bancaires s'il y en a
    await prisma.bankInfo.deleteMany({
      where: { userId: admin.id }
    });

    // Ajouter les informations bancaires de l'admin
    const bankInfos = [
      {
        userId: admin.id,
        type: 'mobile_money' as const,
        accountNumber: '0341234567',
        accountName: 'Admin Tolotanana',
        provider: 'Orange Money',
        isDefault: true
      },
      {
        userId: admin.id,
        type: 'mobile_money' as const,
        accountNumber: '0321234567',
        accountName: 'Admin Tolotanana',
        provider: 'Mvola',
        isDefault: false
      },
      {
        userId: admin.id,
        type: 'bank_account' as const,
        accountNumber: '1234567890123456',
        accountName: 'Admin Tolotanana',
        provider: 'Bank of Africa',
        isDefault: false
      },
      {
        userId: admin.id,
        type: 'bank_account' as const,
        accountNumber: '9876543210987654',
        accountName: 'Admin Tolotanana',
        provider: 'BNI Madagascar',
        isDefault: false
      }
    ];

    for (const bankInfo of bankInfos) {
      const created = await prisma.bankInfo.create({
        data: bankInfo
      });
      console.log(`‚úÖ Info bancaire cr√©√©e: ${created.provider} - ${created.accountNumber}`);
    }

    console.log('‚úÖ Admin bank info seed completed');
  } catch (error) {
    console.error('‚ùå Erreur lors du seed admin bank info:', error);
    throw error;
  }
}

// ==================== SEED PLATFORM FEES ====================
async function seedPlatformFees(admin: any) {
  try {
    console.log('üå± Seeding platform fees...');

    // V√©rifier si des frais existent d√©j√†
    const existingFees = await prisma.platformFees.findFirst();
    
    if (existingFees) {
      console.log('‚úÖ Des frais de plateforme existent d√©j√†.');
      return;
    }

    // Cr√©er les frais par d√©faut
    const defaultFees = await prisma.platformFees.create({
      data: {
        percentage: 5.0,
        description: 'Frais de plateforme par d√©faut pour couvrir les co√ªts op√©rationnels',
        isActive: true,
        createdBy: admin.id,
      },
    });

    console.log('‚úÖ Frais de plateforme cr√©√©s avec succ√®s:', {
      id: defaultFees.id,
      percentage: defaultFees.percentage,
      description: defaultFees.description,
      isActive: defaultFees.isActive,
    });

  } catch (error) {
    console.error('‚ùå Erreur lors du seeding des frais de plateforme:', error);
    throw error;
  }
}

// ==================== SEED TESTIMONIALS ====================
async function seedTestimonials(admin: any) {
  console.log('üå± Seeding testimonials...');

  try {
    // V√©rifier si des t√©moignages existent d√©j√†
    const existingTestimonials = await prisma.testimonial.findFirst();
    if (existingTestimonials) {
      console.log('‚úÖ Des t√©moignages existent d√©j√†.');
      return;
    }

    // T√©moignages de test bas√©s sur l'image fournie
    const testimonials = [
      {
        name: 'Marie Rasoanirina',
        role: 'B√©n√©ficiaire',
        avatar: null,
        content: 'Gr√¢ce √† TOLOTANANA, j\'ai pu collecter les fonds n√©cessaires pour l\'op√©ration de ma fille. La plateforme est simple √† utiliser et la communaut√© est incroyablement g√©n√©reuse. Merci √† tous !',
        campaign: 'Aide pour les frais m√©dicaux de ma fille',
        rating: 5,
        isActive: true,
        isHighlight: true,
        createdBy: admin.id,
      },
      {
        name: 'Jean Rakotomalala',
        role: 'Cr√©ateur de campagne',
        avatar: null,
        content: 'TOLOTANANA m\'a permis de r√©aliser mon r√™ve de construire une √©cole dans mon village. Le processus est transparent et l\'√©quipe est tr√®s professionnelle. Je recommande vivement !',
        campaign: 'Construction d\'une √©cole rurale √† Antsirabe',
        rating: 5,
        isActive: true,
        isHighlight: true,
        createdBy: admin.id,
      },
      {
        name: 'Sarah Andriamalala',
        role: 'Donatrice',
        avatar: null,
        content: 'J\'adore utiliser TOLOTANANA pour soutenir des causes qui me tiennent √† c≈ìur. C\'est rassurant de voir l\'impact direct de mes dons et de suivre les progr√®s des campagnes.',
        campaign: 'Donatrice r√©guli√®re',
        rating: 5,
        isActive: true,
        isHighlight: true,
        createdBy: admin.id,
      },
      {
        name: 'Pierre Randrianarivo',
        role: 'B√©n√©ficiaire',
        avatar: null,
        content: 'Apr√®s le cyclone, TOLOTANANA nous a aid√©s √† reconstruire notre maison. La solidarit√© de la communaut√© malgache est extraordinaire. Cette plateforme change vraiment des vies.',
        campaign: 'Reconstruction apr√®s cyclone',
        rating: 5,
        isActive: true,
        isHighlight: true,
        createdBy: admin.id,
      },
      {
        name: 'Lucie Ratsimba',
        role: 'Donatrice',
        avatar: null,
        content: 'Je donne r√©guli√®rement sur TOLOTANANA car je sais que chaque ariary va directement aux personnes dans le besoin. La transparence et la confiance sont essentielles pour moi.',
        campaign: 'Donatrice fid√®le',
        rating: 5,
        isActive: true,
        isHighlight: true,
        createdBy: admin.id,
      },
      {
        name: 'Marc Ravelojaona',
        role: 'Cr√©ateur de campagne',
        avatar: null,
        content: 'TOLOTANANA m\'a aid√© √† financer mon projet de biblioth√®que mobile. L\'√©quipe m\'a accompagn√© √† chaque √©tape et les donateurs sont tr√®s engag√©s. Une exp√©rience exceptionnelle !',
        campaign: 'Biblioth√®que mobile pour enfants',
        rating: 5,
        isActive: true,
        isHighlight: true,
        createdBy: admin.id,
      },
      // T√©moignages suppl√©mentaires (non mis en avant)
      {
        name: 'Hery Andriamanantsoa',
        role: 'Donateur',
        avatar: null,
        content: 'Excellente plateforme pour aider les autres. Interface claire et processus de don s√©curis√©.',
        campaign: null,
        rating: 4,
        isActive: true,
        isHighlight: false,
        createdBy: admin.id,
      },
      {
        name: 'Naina Rakotovao',
        role: 'B√©n√©ficiaire',
        avatar: null,
        content: 'Merci √† TOLOTANANA pour m\'avoir aid√© √† financer mes √©tudes. Gr√¢ce √† vous, je peux maintenant aider d\'autres jeunes.',
        campaign: 'Financement √©tudes sup√©rieures',
        rating: 5,
        isActive: true,
        isHighlight: false,
        createdBy: admin.id,
      },
    ];

    // Cr√©er les t√©moignages
    for (const testimonial of testimonials) {
      await prisma.testimonial.create({
        data: testimonial,
      });
    }

    console.log(`‚úÖ ${testimonials.length} t√©moignages ajout√©s avec succ√®s !`);
    
    // Afficher les statistiques
    const stats = await prisma.testimonial.groupBy({
      by: ['role', 'isHighlight'],
      _count: true,
    });

    console.log('üìä Statistiques des t√©moignages :');
    stats.forEach(stat => {
      const highlight = stat.isHighlight ? ' (Mis en avant)' : '';
      console.log(`   ${stat.role}${highlight}: ${stat._count}`);
    });

    // Calculer la note moyenne
    const avgRating = await prisma.testimonial.aggregate({
      _avg: { rating: true },
    });

    console.log(`‚≠ê Note moyenne : ${avgRating._avg.rating}/5`);

  } catch (error) {
    console.error('‚ùå Erreur lors de l\'ajout des t√©moignages:', error);
    throw error;
  }
}

// ==================== SEED CONTACT MESSAGES ====================
async function seedContactMessages(admin: any) {
  console.log('üå± Seeding contact messages...');

  try {
    // V√©rifier si des messages existent d√©j√†
    const existingMessages = await prisma.contactMessage.findFirst();
    if (existingMessages) {
      console.log('‚úÖ Des messages de contact existent d√©j√†.');
      return;
    }

    // Messages de test
    const testMessages = [
      {
        name: 'Marie Rakoto',
        email: 'marie.rakoto@email.com',
        subject: 'Question sur les frais de plateforme',
        message: 'Bonjour,\n\nJ\'aimerais avoir plus d\'informations sur les frais appliqu√©s lors des donations. Sont-ils fixes ou variables ?\n\nMerci pour votre r√©ponse.',
        isRead: false,
      },
      {
        name: 'Jean Randria',
        email: 'jean.randria@email.com',
        subject: 'Probl√®me avec ma campagne',
        message: 'Salut,\n\nMa campagne n\'appara√Æt pas dans les r√©sultats de recherche. Pouvez-vous v√©rifier s\'il y a un probl√®me ?\n\nCampagne : "Aide pour l\'√©cole de mon village"\n\nMerci !',
        isRead: true,
        isReplied: true,
        reply: 'Bonjour Jean,\n\nMerci pour votre message. J\'ai v√©rifi√© votre campagne et elle est maintenant visible dans les r√©sultats de recherche. Il y avait un petit probl√®me technique qui a √©t√© r√©solu.\n\nN\'h√©sitez pas si vous avez d\'autres questions.\n\nCordialement,\nL\'√©quipe Tolotanana',
        repliedBy: admin.id,
        repliedAt: new Date('2024-01-15T10:30:00Z'),
      },
      {
        name: 'Hery Rasolofo',
        email: 'hery.rasolofo@email.com',
        subject: 'Demande de partenariat',
        message: 'Bonjour,\n\nJe repr√©sente une ONG locale et nous aimerions explorer une collaboration avec votre plateforme pour nos campagnes de collecte de fonds.\n\nPourriez-vous me mettre en contact avec la personne responsable des partenariats ?\n\nCordialement,\nHery Rasolofo\nDirecteur - ONG Fihavanana',
        isRead: true,
      },
      {
        name: 'Naina Andriamanana',
        email: 'naina.andriamanana@email.com',
        subject: 'Retrait de fonds bloqu√©',
        message: 'Bonjour,\n\nJ\'ai fait une demande de retrait il y a une semaine mais je n\'ai toujours pas re√ßu les fonds. Le statut indique "En cours de traitement".\n\nPouvez-vous m\'aider ?\n\nMon ID de demande : WR123456\n\nMerci',
        isRead: false,
      },
      {
        name: 'Tiana Rakotomalala',
        email: 'tiana.rakotomalala@email.com',
        subject: 'F√©licitations pour la plateforme',
        message: 'Bonjour,\n\nJe voulais juste vous f√©liciter pour cette excellente initiative ! J\'ai pu aider plusieurs campagnes gr√¢ce √† votre plateforme.\n\nL\'interface est intuitive et le processus de don est tr√®s simple.\n\nContinuez comme √ßa !\n\nTiana',
        isRead: true,
        isReplied: true,
        reply: 'Bonjour Tiana,\n\nMerci beaucoup pour ce message tr√®s encourageant ! C\'est gr√¢ce √† des utilisateurs comme vous que notre plateforme peut avoir un impact positif.\n\nN\'h√©sitez pas √† partager Tolotanana autour de vous pour aider encore plus de causes.\n\nMerci encore !\nL\'√©quipe Tolotanana',
        repliedBy: admin.id,
        repliedAt: new Date('2024-01-10T14:20:00Z'),
      }
    ];

    // Cr√©er les messages
    for (const messageData of testMessages) {
      await prisma.contactMessage.create({ data: messageData });
    }

    console.log(`‚úÖ ${testMessages.length} messages de contact ajout√©s avec succ√®s !`);
    
    // Afficher les statistiques
    const stats = await prisma.contactMessage.groupBy({
      by: ['isRead', 'isReplied'],
      _count: true,
    });

    console.log('üìä Statistiques des messages :');
    stats.forEach(stat => {
      const status = stat.isReplied ? 'R√©pondus' : stat.isRead ? 'Lus' : 'Non lus';
      console.log(`   ${status}: ${stat._count}`);
    });

  } catch (error) {
    console.error('‚ùå Erreur lors de l\'ajout des messages:', error);
    throw error;
  }
}

// ==================== FONCTION PRINCIPALE ====================
async function runAllSeeds() {
  try {
    console.log('üöÄ D√©marrage de tous les seeds...\n');

    // 1. Seed principal (utilisateurs, campagnes, etc.)
    const { admin, donor, requester } = await seedMain();
    console.log('');

    // 2. Seed admin bank info
    await seedAdminBankInfo(admin);
    console.log('');

    // 3. Seed platform fees
    await seedPlatformFees(admin);
    console.log('');

    // 4. Seed testimonials
    await seedTestimonials(admin);
    console.log('');

    // 5. Seed contact messages
    await seedContactMessages(admin);
    console.log('');

    console.log('üéâ Tous les seeds ont √©t√© ex√©cut√©s avec succ√®s!');
    console.log('\nüìä R√©sum√© des donn√©es cr√©√©es :');
    console.log('   üë§ Utilisateurs : Admin, Donateur, Demandeur');
    console.log('   üè∑Ô∏è  Cat√©gories : Sant√©, √âducation, Environnement, Entrepreneuriat');
    console.log('   üìã Campagnes : 2 campagnes de test');
    console.log('   üí∞ Donations : 3 donations de test');
    console.log('   üè¶ Infos bancaires : Admin + Demandeur');
    console.log('   üí≥ Frais de plateforme : 5% par d√©faut');
    console.log('   üí¨ T√©moignages : 8 t√©moignages (6 mis en avant)');
    console.log('   üìß Messages contact : 5 messages de test');
    console.log('\n‚ú® Votre base de donn√©es est pr√™te √† √™tre utilis√©e !');

  } catch (error) {
    console.error('‚ùå Erreur lors de l\'ex√©cution des seeds:', error);
    throw error;
  }
}

// ==================== EX√âCUTION ====================
runAllSeeds()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });